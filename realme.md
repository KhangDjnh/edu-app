# Education System — Full Feature Reference (realme.md)

This document describes the features, architecture, API surface, data model highlights, security, integrations and local run instructions for the Education System (E-Learning & Online Examination) backend.

> Note: This file was generated by scanning the repository source code. Use it as a single-source summary for developers and integrators.

---

## Table of Contents

- Project overview
- Tech stack & libraries
- High-level architecture
- Main features (by module)
  - Authentication & Users
  - Classes & Class membership
  - Assignments & Submissions
  - Documents & Files
  - Exams (create, start, submit, grade)
  - Questions & Answers
  - Attendance
  - Chat & Notifications
  - Learning Roadmaps
  - Rooms (live classes)
  - Posts, Comments & Reactions
  - Leave requests
  - Scores & Export
- Important Entities (data model highlights)
- Security & Roles
- Integrations & External services
- Configuration / Environment variables
- Running locally (quick start)
- API discovery & OpenAPI
- Notes, caveats and next steps

---

## Project overview

This Spring Boot application provides a backend for a full-featured education system: user management, class management, assignment workflows, file uploads, online exams with timed submissions, question bank, grading, attendance tracking, chat, notifications, learning roadmap/content, and room-based live sessions.

The code uses Spring Boot 3.x, Java 21, JPA/Hibernate, and integrates with Keycloak (IDP), Cloudflare R2 (S3 compatible storage), Redis, WebSocket/STOMP for real-time features, and Apache POI / iText for document export.


## Tech stack & libraries

- Java 21
- Spring Boot 3.3.x
  - spring-boot-starter-web, data-jpa, security, validation, mail, websocket, redis
- Database: MySQL (via MySQL Connector/J)
- Object mapping: MapStruct
- Authentication/Authorization: Keycloak (admin client) + OAuth2 resource server (JWT)
- Storage: Cloudflare R2 (AWS SDK v2 S3 client)
- Realtime: Spring WebSocket + STOMP
- File generation/export: iText (PDF), Apache POI (Excel)
- OpenAPI docs: springdoc-openapi
- Testing: spring-boot-starter-test
- Others: Lombok, Spring Cloud OpenFeign


## High-level architecture

- Controllers define REST endpoints grouped by feature (classes, exams, assignments, etc.).
- Services implement business logic and coordinate repositories, file storage, and notifications.
- Entities (JPA) model database tables.
- Security: OAuth2 resource server validates JWTs and maps roles via a custom authority converter.
- Cloud storage: S3-compatible client configured to point to Cloudflare R2.
- Real-time chat: WebSocket endpoints with STOMP broker.


## Main features (by module)

Below is a concise feature list with key endpoints and usage notes. All responses use a uniform wrapper `ApiResponse<T>` with `message`, `code`, and `result`.

### Authentication & Users

- Endpoints (AuthController)
  - POST /api/auth/login — Login with email + password (returns `LoginResponse`).
  - POST /api/auth/register — Register a pending user (email confirmation required).
  - GET /api/auth/validate-token — Validate attached JWT (returns simple boolean response).

- User management (UserController)
  - POST /api/users — Create user (admin or system registration flow).
  - GET /api/users — List all users (admin).
  - GET /api/users/{id} — Get user by ID.
  - GET /api/users/getUserInfo — Get current user info from token.
  - PUT /api/users/{id} — Update user (admin or owner).
  - PUT /api/users/{id}/change-password — Change password (admin or owner).
  - DELETE /api/users/{id} — Delete user.

Notes: Registration creates a pending user entry and an email confirmation flow (`/api/confirm-email`). Keycloak is used for IDP administration and user sync.


### Classes & Class membership

- ClassController
  - POST /api/classes — Create class (TEACHER).
  - GET /api/classes — List all classes (ADMIN).
  - GET /api/classes/{id} — Get class details (TEACHER or STUDENT).
  - GET /api/classes/teacher — Get classes taught by current teacher.
  - PUT /api/classes/{id} — Update class (TEACHER).
  - DELETE /api/classes/{id} — Delete class (TEACHER).

- ClassStudent flows: student joining, listing members and student-specific responses are supported via `ClassStudentController` (present in project).


### Assignments & Submissions

- AssignmentController
  - POST /api/assignments — Create assignment with optional file upload (TEACHER).
  - GET /api/assignments/{id} — Get assignment details (STUDENT / TEACHER).
  - GET /api/assignments/student/{studentId} — Paginated assignments for a student with filters.
  - GET /api/assignments/{classId}/class — Get assignments in a class.
  - PUT /api/assignments/{id} — Update assignment (TEACHER).
  - DELETE /api/assignments/{id} — Delete assignment (TEACHER).

- SubmissionController
  - POST /api/submissions — Student submits assignment (multipart allowed).
  - GET /api/submissions/{id} — Get submission details.
  - GET /api/submissions/assignment/{assignmentId}/student/{studentId} — Get a student's submission for an assignment.
  - GET /api/submissions/class/{classId}/student/{studentId} — List submissions by student in class.
  - GET /api/submissions/assignment/{assignmentId} — Teacher: list submissions for an assignment.
  - PUT /api/submissions/{id}/grade — Teacher grades submission.
  - DELETE /api/submissions/{id} — Delete submission (owner or teacher).

Notes: File uploads stored through Cloudflare R2 integration.


### Documents & Files

- DocumentController
  - POST /api/documents — Upload document (TEACHER) with multipart.
  - GET /api/documents/{id} — Retrieve document by id.
  - GET /api/documents — Admin-only list.
  - GET /api/documents/class/{classId} — Documents in a class.
  - PUT /api/documents/{id} — Update document (TEACHER).
  - DELETE /api/documents/{id} — Delete document (TEACHER).

- FileController
  - POST /api/files/images/upload — Upload image.
  - POST /api/files/upload — Upload file.
  - GET /api/files/{fileId} — Get file metadata.
  - GET /api/files/get?fileUrl=... — Download file as ByteArrayResource.

Storage is managed by Cloudflare R2 via an S3Client.


### Exams (create, start, submit, grade)

- ExamController
  - POST /api/exams/random — Create random exam assembled from question bank (TEACHER).
  - POST /api/exams/choose — Create an exam by selecting question IDs (TEACHER).
  - GET /api/exams/{id} — Get exam details (STUDENT / TEACHER).
  - GET /api/exams/{classId}/class — Teacher: exams of a class.
  - GET /api/exams/class/{classId}/student — Student: exams available in class.
  - PUT /api/exams/{examId} — Update exam (TEACHER).
  - PUT /api/exams/{examId}/start — Mark exam started (TEACHER).
  - DELETE /api/exams/{examId} — Delete exam (TEACHER).

- StartExamController (runtime submission)
  - POST /api/exams/{examId}/start — Start an exam session and create an `ExamSubmission` (STUDENT or TEACHER can start if allowed).
  - GET /api/exams/{examId}/get-submission — Student: get their submission for an exam.
  - POST /api/exams/{submissionId}/submit — Student: submit their submission (closes attempt).
  - GET /api/exams/submission/{submissionId}/result — Get computed score for a submission.
  - GET /api/exams/{examId}/results — Teacher/Student: get all results for an exam.

- ExamQuestionController
  - GET /api/exams/{examId}/questions — Paginated questions for an exam.

- ExamAnswerController
  - POST /api/exam-submissions/{submissionId}/answers — Student posts answers to questions in their submission.

Notes: The system supports random assembly of questions by difficulty and timed exams. Auto-grading & result computation implemented by services.


### Questions & Question Bank

- QuestionController provides endpoints to create, update, search and manage questions (question types, options, difficulty, tags, etc.). Questions are used by random exam creation and choose-exam flows.


### Attendance

- AttendanceController
  - POST /api/attendance — Create attendance for a class on a date (TEACHER). Request includes list of attendances per student and their statuses.
  - PUT /api/attendance/{id} — Update attendance entry (TEACHER / STUDENT where allowed).
  - GET /api/attendance/{id} — Get attendance by ID.
  - GET /api/attendance/class?classId=...&attendanceDate=... — Teacher: get all attendance in a class on a date.
  - GET /api/attendance/student?studentId=...&classId=... — Student: get their attendances in a class.

Attendance entity supports linking to an `Exam` (for exam-specific attendance) and uses `AttendanceStatus` enum (e.g., PRESENT / ABSENT / LATE).


### Chat & Notifications

- ChatController (STOMP + REST)
  - GET /chat/conversation — List user's conversations (pagination).
  - GET /chat/messages — Get messages from a conversation (pagination).
  - PUT /chat/conversation — Create/return conversation between two users.
  - POST /chat/messages (multipart) — Send a message (attachments supported).
  - DELETE /chat/messages/{messageId} — Delete message.

- NoticeController
  - GET /api/notices/{userId}/count — Count unread notices for a user.
  - GET /api/notices/{id} — Get notice by id.
  - GET /api/notices/user/{userId} — List notices for a user.
  - PUT /api/notices/{id}/read — Mark as read.

Real-time messages are routed through STOMP endpoints (`/ws`) and an application destination prefix `/app` is configured.


### Learning Roadmaps

- LearningRoadmapController
  - POST /api/learning-roadmaps — Create roadmap content (multipart).
  - GET /api/learning-roadmaps/class/{classId} — Get roadmap items for a class.
  - PUT /api/learning-roadmaps/{id} — Update roadmap item (multipart).
  - DELETE /api/learning-roadmaps/{id} — Delete roadmap item.

Roadmaps can have parent-child relationships and file attachments.


### Rooms (live classes)

- RoomController
  - POST /api/rooms/create — Create a room (TEACHER).
  - POST /api/rooms/join — Join a room (TEACHER or STUDENT).
  - POST /api/rooms/leave — Leave a room.
  - PUT /api/rooms/{roomId}/callout — Trigger callout (announce) in room.
  - PUT /api/rooms/{roomId}/save-path?path=... — Save recorded class path.
  - GET /api/rooms/class/{classId}/check — Check active room for a class.


### Posts, Comments & Reactions

- PostController
  - POST /api/posts/create — Create post (multipart).
  - GET /api/posts/class?classId=... — Get posts for class.
  - GET /api/posts/{postId} — Get a single post.
  - PUT /api/posts/update/{postId} — Update post (multipart).
  - POST /api/posts/emotion — Set emotion/reaction for a post.
  - DELETE /api/posts/{postId} — Delete post.

- CommentController
  - POST /api/comments/create — Create comment.
  - GET /api/comments/{commentId} — Get a comment.
  - GET /api/comments/post/{postId} — List comments for post.
  - DELETE /api/comments/{commentId} — Delete comment.


### Leave requests

- LeaveRequestController
  - POST /api/leave-request — Student creates leave request.
  - GET /api/leave-request/{id} — Get details.
  - PUT /api/leave-request/{id}/approve — Teacher approves.
  - PUT /api/leave-request/{id}/reject — Teacher rejects.
  - GET /api/leave-request/class/{classId} — Teacher: list leave requests for class.
  - GET /api/leave-request/student?studentId=...&classId=... — Student: list their leave requests.


### Scores & Export

- ScoreController
  - GET /api/scores/{studentId}/students — All scores of a student.
  - GET /api/scores/{examId}/exams — Scores for an exam.
  - GET /api/scores/classes?classId=...&examId=... — Scores by class & exam.
  - GET /api/scores/exams?studentId=...&examId=... — Score detail for a student & exam.
  - GET /api/scores/exam-student?classId=...&studentId=... — Scores per student in a class.
  - GET /api/scores/summary?classId=... — Class score summary.
  - GET /api/scores/classes/{classId}/scores/export — Teacher: export class scores to Excel.


## Important Entities (data model highlights)

A non-exhaustive list of core entities and key fields:

- User
  - id, username, email, password, role (UserRole), keycloakUserId, avatar, primarySubject, isActive

- ClassEntity
  - id, name, code, semester, description, teacher (User)

- Assignment
  - id, title, content, classId, startAt, endAt, attached file

- Submission
  - id, student (User), assignment, title, content, files, grade

- Exam
  - id, title, class, startTime, endTime, description, questions, status

- ExamSubmission
  - id, exam, student, startedAt, submittedAt, answers, computed score

- Question
  - id, content, type, difficulty, options, correctAnswer(s)

- Attendance
  - id, classEntity, student, attendanceDate, status (AttendanceStatus), exam (optional)

- Room
  - id, name, class, teacher, startTime, path (recording path), active flag

- FileRecord
  - id, url, filename, contentType, size, uploadedBy


## Security & Roles

- The application is configured as an OAuth2 resource server validating JWT tokens.
- Roles enforced via method security annotations (`@PreAuthorize`) using roles like ADMIN, TEACHER, STUDENT, USER.
- Public endpoints: login, register, email confirmation, and Swagger endpoints. All other endpoints require authentication.
- A custom JWT authority converter (`CustomAuthoritiesConverter`) maps Keycloak JWT claims to Spring authorities.


## Integrations & External services

- Keycloak — used as Identity Provider; `KeycloakConfig` provides an admin client for programmatic operations.
- Cloudflare R2 (S3-compatible) — used for file and image storage; configured with an S3Client in `CloudflareR2Config`.
- Redis — Spring Data Redis dependency indicates presence of caching/real-time usage (websocket or other features may use it).
- Email — spring mail for sending confirmation emails and notifications.
- WebSocket (STOMP) — for chat and real-time notifications. Endpoint `/ws` exposed.


## Configuration / Environment variables

The main application reads properties from `application.yml` and `application-local.yml`. Important properties expected in environment or config:

- Database (spring.datasource.*) — URL, username, password
- Keycloak identity provider:
  - idp.url
  - idp.realm
  - idp.client-id
  - idp.client-secret
- Cloudflare R2 / S3:
  - r2.endpoint (or similar property under `CloudflareR2Properties`)
  - r2.accessKey
  - r2.secretKey
  - r2.region
- Mail settings for SMTP (spring.mail.*)
- Spring OAuth2 resource server config (issuer-uri or jwk-set-uri) for validating JWTs

Check `src/main/resources/application-local.yml` for local example values.


## Running locally (quick start)

Minimum steps to run locally (assumes you have Java 21 and Maven):

1. Configure `application-local.yml` or environment variables for DB, Keycloak and Cloudflare R2.
2. Start a MySQL instance and apply schema (JPA will auto-create/update depending on config).
3. Build and run:

```bash
mvnw.cmd clean package
mvnw.cmd spring-boot:run -Dspring-boot.run.profiles=local
```

4. Visit API docs (if enabled) at: http://localhost:8080/swagger-ui/index.html or `/swagger-ui/`.

Notes: If Keycloak or Cloudflare R2 are not available for local development, you can:
- Use a local S3-compatible service (minio) and point `CloudflareR2Properties` to it.
- For auth, either run Keycloak locally and create the realm/client, or temporarily disable resource-server validation for quick testing (not recommended for production).


## API discovery & OpenAPI

The project includes `springdoc-openapi` dependency — OpenAPI UI should be available under `/swagger-ui/` when the server is running.


## Notes, caveats and next steps

- The project uses Keycloak for authentication; JWT validation requires correct issuer/jwk configuration in properties.
- Cloudflare R2 configuration uses AWS SDK v2 and path-style access; ensure endpoint/region/credentials are correct.
- The code enforces method-level security (`@PreAuthorize`); tests or front-end should call endpoints with correct role claims.
- Some flows assume background processes (e.g., grading, scheduled tasks) are implemented in services — refer to `service` package for exact behavior.

Recommended next steps for contributors:
- Add a developer README with step-by-step Keycloak setup (realm, client, client secret) for local dev.
- Provide docker-compose with database, keycloak, redis and minio for reproducible local environment.
- Expand OpenAPI docs annotations so endpoints have detailed request/response schemas and example payloads.

---

If you'd like, I can:
- Generate a more compact API reference (endpoints + request/response examples) file.
- Create a `README.md` with step-by-step local dev `docker-compose.yml` and Keycloak setup instructions.
- Produce an entity-relationship diagram (text-based) listing relationships between core entities.

Which of those would you like next?
